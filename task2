#!/bin/bash

if [ "$HOSTNAME"=="server" ]; then

#Packets
sudo apt-get install php-gd php-bcmath php-mbstring php-xml php-ldap php-json php-mysql php-curl php-cgi php libapache2-mod-php -y && sudo apt-get install apache2 && sudo apt-get install mariadb-server mariadb-client -y 

sudo systemctl start apache2

#DATABASE
sudo systemctl start mariadb
sudo systemctl enable mariadb

sudo mysql_secure_installetion

sudo mysql -u -root -e "CREATE DATABSE zabbix character set utf8 collate utf8_bin;"
sudo mysql -u -root -e "CREATE USER 'zabbix'@'localhost' IDENTIFIED BY '123456';"
sudo mysql -u -root -e "GRANT ALL PRIVILEGES ON zabbix.* TO 'zabbix'@'localhost';"

#install zabbix
wget /tmp https://repo.zabbix.com/zabbix/5.3/debian/pool/main/z/zabbix-release/zabbix-release_5.3-1%2Bdebian10_all.deb
dpkg -i zabbix-release_5.3-1+buster_all.deb
apt-get update
sudo apt-get install zabbix-server-mysql zabbix-frontend-php zabbix-apache-conf zabbix-agent

#Zabbix config
sed -i "/\# DBHost=/c DBHsot=localhost" /etc/zabbix/zabbix_server.conf
sed -i "/DBHost=/c DBHsot=localhost" /etc/zabbix/zabbix_server.conf
sed -i "/\# DBName=/d" /etc/zabbix/zabbix_server.conf
sed -i "/DBName=/c DBName=zabbix" /etc/zabbix/zabbix_server.conf
sed -i "/\# DBUser=/d" /etc/zabbix/zabbix_server.conf
sed -i "/DBUser=/c DBUser=zabbix" /etc/zabbix/zabbix_server.conf
sed -i "/\# DBPasswordr=/c DBPassworf=123456" /etc/zabbix/zabbix_server.conf
sed -i "/DBPasswordr=/c DBPassworf=123456" /etc/zabbix/zabbix_server.conf

#Apache config
sed -i "/\# php_value date.timezone/c \ \ \ \ \ php_value date.timezone Europe.Minsk /etc/zabbix/apache.conf

sudo systemctl restart apache2

sudo systemctl start zabbix-server zabbix-agent
sudo systemctl enable zabbix-server zabbix-agent

elif [ "$HOSTNAME"=="agent" ]; then

sudo apt-get install php-gd php-bcmath php-mbstring php-xml php-ldap php-json php-mysql php-curl php-cgi php libapache2-mod-php -y && sudo apt-get install apache2 && sudo apt-get install mariadb-server mariadb-client -y 

sudo apt-get install zabbix-agent

sed -a "$/Server=192.168.13.117/" /etc/zabbix/zabbix_agentd.conf
sed -a "$/ServerActive=192.168.13.117/" /etc/zabbix/zabbix_agentd.conf
sed -a "$/Hostname=srv10/" /etc/zabbix/zabbix_agentd.conf

else
echo "Not found access hostname"
